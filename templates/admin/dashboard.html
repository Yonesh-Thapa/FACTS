{% extends "admin/layout.html" %}

{% block title %}F.A.C.T.S - Admin Dashboard{% endblock %}

{% block page_title %}Admin Dashboard{% endblock %}

{% block head_extras %}
<style>
    .modal-body {
        white-space: pre-line; /* Preserve line breaks */
    }
    
    .contact-name {
        font-weight: inherit;
        text-decoration: none;
        color: var(--primary-color);
        cursor: pointer;
    }
    
    .contact-name:hover {
        text-decoration: underline;
    }
    
    .table tr.table-primary .contact-name {
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h5 class="section-title">Contact Statistics</h5>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-icon bg-primary-light">
                <i class="fas fa-envelope"></i>
            </div>
            <div class="stats-data">
                <h3 class="stats-number">{{ total_contacts }}</h3>
                <p class="stats-label">Total Contacts</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-icon bg-secondary-light">
                <i class="fas fa-user-check"></i>
            </div>
            <div class="stats-data">
                <h3 class="stats-number">{{ interested_contacts }}</h3>
                <p class="stats-label">Interested in Program</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-icon bg-danger-light">
                <i class="fas fa-envelope-open-text"></i>
            </div>
            <div class="stats-data">
                <h3 class="stats-number">{{ unread_contacts }}</h3>
                <p class="stats-label">Unread Messages</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stats-card">
            <div class="stats-icon bg-info-light">
                <i class="fas fa-calendar-check"></i>
            </div>
            <div class="stats-data">
                <h3 class="stats-number">{{ recent_contacts|length }}</h3>
                <p class="stats-label">Recent Contacts</p>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <h5 class="section-title">Class Session Statistics</h5>
    </div>
    <div class="col-md-4">
        <div class="stats-card">
            <div class="stats-icon bg-success-light">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <div class="stats-data">
                <h3 class="stats-number">{{ active_sessions }}</h3>
                <p class="stats-label">Active Sessions</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stats-card">
            <div class="stats-icon bg-primary-light">
                <i class="fas fa-leaf"></i>
            </div>
            <div class="stats-data">
                <h3 class="stats-number">{{ fall_sessions }}</h3>
                <p class="stats-label">Fall Sessions</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stats-card">
            <div class="stats-icon bg-success-light">
                <i class="fas fa-seedling"></i>
            </div>
            <div class="stats-data">
                <h3 class="stats-number">{{ spring_sessions }}</h3>
                <p class="stats-label">Spring Sessions</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>Recent Contact Submissions</span>
                <div>
                    <a href="{{ url_for('admin_classes') }}" class="btn btn-sm btn-success me-2">
                        <i class="fas fa-calendar-alt"></i> Manage Classes
                    </a>
                    <a href="{{ url_for('admin_contacts') }}" class="btn btn-sm btn-primary">
                        <i class="fas fa-envelope"></i> View All Contacts
                    </a>
                </div>
            </div>
            <div class="card-body">
                {% if recent_contacts %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Subject</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Interested</th>
                                <th>Class</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for contact in recent_contacts %}
                            <tr {% if not contact.is_read %}class="table-primary"{% endif %}
                                {% if not contact.is_read %}style="font-weight: bold;"{% endif %}>
                                <td>
                                    <a href="#" class="contact-name" data-bs-toggle="modal" data-bs-target="#messageModal{{ contact.id }}"
                                       {% if not contact.is_read %}data-contact-id="{{ contact.id }}"{% endif %}>
                                        {{ contact.name }}
                                    </a>
                                </td>
                                <td><a href="mailto:{{ contact.email }}">{{ contact.email }}</a></td>
                                <td>{{ contact.subject or "N/A" }}</td>
                                <td>{{ contact.created_at.strftime('%d %b %Y') }}</td>
                                <td>
                                    {% if not contact.is_read %}
                                    <span class="badge bg-danger">Unread</span>
                                    {% else %}
                                    <span class="badge bg-light text-dark">Read</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if contact.interested %}
                                    <span class="badge bg-success">Yes</span>
                                    {% else %}
                                    <span class="badge bg-secondary">No</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if contact.class_assignment %}
                                        <span class="badge bg-primary">{{ contact.class_assignment|title }}</span>
                                    {% else %}
                                        <span class="badge bg-light text-dark">Unassigned</span>
                                    {% endif %}
                                </td>
                                
                                <!-- Modal for displaying the message -->
                                <div class="modal fade" id="messageModal{{ contact.id }}" tabindex="-1" aria-labelledby="messageModalLabel{{ contact.id }}" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="messageModalLabel{{ contact.id }}">Message from {{ contact.name }}</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                <p><strong>Subject:</strong> {{ contact.subject or "N/A" }}</p>
                                                <p><strong>Message:</strong></p>
                                                <div class="p-3 bg-light rounded">
                                                    {{ contact.message|nl2br }}
                                                </div>
                                                <div class="mt-3">
                                                    <p><strong>Assign to Class:</strong></p>
                                                    <form method="POST" action="{{ url_for('assign_contact_to_class', contact_id=contact.id) }}" class="row g-3 align-items-end">
                                                        <div class="col-md-8">
                                                            <select name="class_assignment" class="form-select" aria-label="Assign to class">
                                                                <option value="" {% if not contact.class_assignment %}selected{% endif %}>-- Unassigned --</option>
                                                                <option value="fall" {% if contact.class_assignment == 'fall' %}selected{% endif %}>Fall Class</option>
                                                                <option value="spring" {% if contact.class_assignment == 'spring' %}selected{% endif %}>Spring Class</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-md-4">
                                                            <button type="submit" class="btn btn-primary">Save</button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                <form method="POST" action="{{ url_for('delete_contact', contact_id=contact.id) }}" class="d-inline delete-form">
                                                    <button type="submit" class="btn btn-danger" title="Delete" onclick="return confirm('Are you sure you want to delete this message?')">
                                                        <i class="fas fa-trash"></i> Delete
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-center py-3">No contact submissions yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle marking messages as read when viewing
        const viewButtons = document.querySelectorAll('.contact-name[data-contact-id]');
        viewButtons.forEach(button => {
            button.addEventListener('click', function() {
                const contactId = this.getAttribute('data-contact-id');
                
                if (contactId) {
                    // Send AJAX request to mark as read
                    fetch(`/admin/contacts/${contactId}/mark-read-ajax`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Update UI to show as read
                            const row = this.closest('tr');
                            row.classList.remove('table-primary');
                            row.style.fontWeight = 'normal';
                            
                            const statusCell = row.querySelector('td:nth-child(5)');
                            if (statusCell) {
                                statusCell.innerHTML = '<span class="badge bg-light text-dark">Read</span>';
                            }
                            
                            // Remove data attribute to prevent duplicate requests
                            this.removeAttribute('data-contact-id');
                            
                            // Update the badge in the sidebar if it exists
                            const badge = document.querySelector('.sidebar-menu .badge');
                            if (badge) {
                                const count = parseInt(badge.textContent) - 1;
                                if (count <= 0) {
                                    badge.remove();
                                } else {
                                    badge.textContent = count;
                                }
                            }
                            
                            // Update the unread count in the statistics
                            const unreadElements = document.querySelectorAll('.stats-number');
                            if (unreadElements.length >= 3) {
                                const unreadElement = unreadElements[2]; // Third stats number is unread messages
                                const unreadCount = parseInt(unreadElement.textContent) - 1;
                                if (unreadCount >= 0) {
                                    unreadElement.textContent = unreadCount;
                                }
                            }
                        }
                    })
                    .catch(error => console.error('Error marking message as read:', error));
                }
            });
        });
    });
</script>
{% endblock %}