{% extends "admin/layout.html" %}

{% block title %}Visual Website Editor - F.A.C.T.S Admin{% endblock %}

{% block head %}
    {{ super() }}
    <!-- Bootstrap 5 CSS for website content -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">Visual Website Editor</h1>
            <small class="text-muted">Edit your live website content directly - all changes sync instantly</small>
        </div>
        <div>
            <button id="editModeToggle" class="btn btn-primary me-2">
                <i class="fas fa-edit me-2"></i>Enable Edit Mode
            </button>
            <button id="saveAllChanges" class="btn btn-success me-2" style="display: none;">
                <i class="fas fa-save me-2"></i>Save All Changes
            </button>
            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Real-time Status -->
    <div class="alert alert-success mb-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h6 class="mb-1"><i class="fas fa-broadcast-tower me-2"></i>Live Content Editor</h6>
                <p class="mb-0 small">
                    You're viewing real website content. Enable Edit Mode to add click-to-edit overlays on every section.
                </p>
            </div>
            <div class="col-md-4 text-end">
                <span class="badge bg-success">
                    <i class="fas fa-circle text-success" style="font-size: 8px;"></i> Real-Time Sync Active
                </span>
            </div>
        </div>
    </div>

    <!-- Edit Mode Toolbar -->
    <div id="editToolbar" class="card shadow mb-4" style="display: none;">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="mb-0 text-success">
                        <i class="fas fa-mouse-pointer me-2"></i>Edit Mode Active
                    </h5>
                    <small class="text-muted">Click on any highlighted element to edit it. Changes save automatically.</small>
                </div>
                <div class="col-md-6 text-end">
                    <div class="btn-group me-2">
                        <button id="undoEdit" class="btn btn-outline-secondary btn-sm" disabled>
                            <i class="fas fa-undo me-1"></i>Undo
                        </button>
                        <button id="redoEdit" class="btn btn-outline-secondary btn-sm" disabled>
                            <i class="fas fa-redo me-1"></i>Redo
                        </button>
                    </div>
                    <button id="saveAllChanges" class="btn btn-success me-2" style="display: none;">
                        <i class="fas fa-save me-2"></i>Save Changes (<span id="changeCount">0</span>)
                    </button>
                    <button id="cancelEditing" class="btn btn-secondary">
                        <i class="fas fa-times me-2"></i>Exit Edit Mode
                    </button>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <div class="edit-status" id="editStatus">
                        <span class="badge bg-info me-2">
                            <i class="fas fa-info-circle me-1"></i>
                            Ready to edit
                        </span>
                        <span id="pendingChanges" class="badge bg-warning me-2" style="display: none;">
                            <i class="fas fa-clock me-1"></i>
                            <span id="pendingCount">0</span> pending changes
                        </span>
                        <span id="saveStatus" class="badge bg-success" style="display: none;">
                            <i class="fas fa-check me-1"></i>
                            All changes saved
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Real Website Content with Edit Overlays -->
    <div class="card shadow">
        <div class="card-body p-0">
            <div id="websitePreview" class="website-preview">
                <!-- Real website content with edit capabilities -->
                <div id="realWebsiteContent" class="real-website-content">
                    <!-- Hero Section -->
                    <section class="hero-section bg-primary text-white py-5" data-edit-section="hero">
                        <div class="container">
                            <div class="row align-items-center">
                                <div class="col-lg-6">
                                    <h1 class="display-4 fw-bold mb-4" 
                                        data-content-key="hero_title" 
                                        data-content-type="text">
                                        {{ site_settings.hero_title or 'Launch Your Accounting Career in 8 Weeks' }}
                                    </h1>
                                    <p class="lead mb-4" 
                                       data-content-key="hero_subtitle" 
                                       data-content-type="text">
                                        {{ site_settings.hero_subtitle or 'Job-ready training for recent graduates in Australia' }}
                                    </p>
                                    <div class="mb-4">
                                        <div class="countdown-container">
                                            <h5 class="text-white mb-3" 
                                                data-content-key="countdown_title" 
                                                data-content-type="text">
                                                {{ site_settings.countdown_title or 'Early Bird Ends In:' }}
                                            </h5>
                                            <div id="countdown-timer" class="countdown-timer text-center">
                                                <!-- Countdown will be populated by JS -->
                                            </div>
                                        </div>
                                    </div>
                                    <div class="hero-buttons">
                                        <a href="{{ url_for('contact') }}" class="btn btn-light btn-lg me-3">
                                            Start Your Journey
                                        </a>
                                        <span class="text-white-50 small">
                                            Next Session: {{ site_settings.next_session_date or 'June 5, 2025' }}
                                        </span>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <img src="{{ url_for('static', filename='images/' + (site_settings.hero_image or 'future-accountant-hero.jpg')) }}" 
                                         alt="Future Accountants Training" 
                                         class="img-fluid rounded shadow"
                                         data-content-key="hero_image" 
                                         data-content-type="image">
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Program Overview -->
                    <section class="program-section py-5" data-edit-section="program">
                        <div class="container">
                            <div class="text-center mb-5">
                                <h2 class="section-title" 
                                    data-content-key="program_title" 
                                    data-content-type="text">
                                    {{ site_settings.program_title or 'Your Path to Accounting Success' }}
                                </h2>
                                <p class="lead text-muted" 
                                   data-content-key="program_subtitle" 
                                   data-content-type="text">
                                    {{ site_settings.program_subtitle or 'Comprehensive 8-week training program designed for recent graduates' }}
                                </p>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4 mb-4">
                                    <div class="feature-card text-center p-4">
                                        <div class="feature-icon mb-3">
                                            <i class="fas fa-graduation-cap fa-3x text-primary"></i>
                                        </div>
                                        <h4 data-content-key="feature1_title" data-content-type="text">
                                            {{ site_settings.feature1_title or 'Expert Training' }}
                                        </h4>
                                        <p data-content-key="feature1_description" data-content-type="text">
                                            {{ site_settings.feature1_description or 'Learn from industry professionals with years of experience' }}
                                        </p>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-4">
                                    <div class="feature-card text-center p-4">
                                        <div class="feature-icon mb-3">
                                            <i class="fas fa-briefcase fa-3x text-success"></i>
                                        </div>
                                        <h4 data-content-key="feature2_title" data-content-type="text">
                                            {{ site_settings.feature2_title or 'Job-Ready Skills' }}
                                        </h4>
                                        <p data-content-key="feature2_description" data-content-type="text">
                                            {{ site_settings.feature2_description or 'Practical skills that employers are looking for' }}
                                        </p>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-4">
                                    <div class="feature-card text-center p-4">
                                        <div class="feature-icon mb-3">
                                            <i class="fas fa-users fa-3x text-info"></i>
                                        </div>
                                        <h4 data-content-key="feature3_title" data-content-type="text">
                                            {{ site_settings.feature3_title or 'Career Support' }}
                                        </h4>
                                        <p data-content-key="feature3_description" data-content-type="text">
                                            {{ site_settings.feature3_description or 'Ongoing support to help you land your dream job' }}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Pricing Section -->
                    <section class="pricing-section bg-light py-5" data-edit-section="pricing">
                        <div class="container">
                            <div class="text-center mb-5">
                                <h2 class="section-title" 
                                    data-content-key="pricing_title" 
                                    data-content-type="text">
                                    {{ site_settings.pricing_title or 'Investment in Your Future' }}
                                </h2>
                            </div>
                            
                            <div class="row justify-content-center">
                                <div class="col-lg-8">
                                    <div class="pricing-card bg-white rounded shadow p-5 text-center">
                                        <div class="pricing-header mb-4">
                                            <h3 class="fw-bold" 
                                                data-content-key="pricing_plan_name" 
                                                data-content-type="text">
                                                {{ site_settings.pricing_plan_name or '8-Week Intensive Program' }}
                                            </h3>
                                            <div class="pricing-amount">
                                                <span class="currency">A$</span>
                                                <span class="price" 
                                                      data-content-key="early_bird_price" 
                                                      data-content-type="price">
                                                    {{ site_settings.early_bird_price or '1500' }}
                                                </span>
                                                <span class="period">/course</span>
                                            </div>
                                            <small class="text-muted">
                                                Early Bird Special (Regular: A$<span data-content-key="regular_price" data-content-type="price">{{ site_settings.regular_price or '1650' }}</span>)
                                            </small>
                                        </div>
                                        
                                        <div class="pricing-features mb-4">
                                            <ul class="list-unstyled">
                                                <li class="mb-2">
                                                    <i class="fas fa-check text-success me-2"></i>
                                                    8 weeks of intensive training
                                                </li>
                                                <li class="mb-2">
                                                    <i class="fas fa-check text-success me-2"></i>
                                                    Wednesday & Thursday evenings
                                                </li>
                                                <li class="mb-2">
                                                    <i class="fas fa-check text-success me-2"></i>
                                                    7:00-9:00 PM AEST
                                                </li>
                                                <li class="mb-2">
                                                    <i class="fas fa-check text-success me-2"></i>
                                                    Industry expert mentorship
                                                </li>
                                                <li class="mb-2">
                                                    <i class="fas fa-check text-success me-2"></i>
                                                    Job placement assistance
                                                </li>
                                            </ul>
                                        </div>
                                        
                                        <a href="{{ url_for('contact') }}" class="btn btn-primary btn-lg">
                                            Secure Your Spot
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Edit Content
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <div class="mb-3">
                        <label for="contentKey" class="form-label">Content Key</label>
                        <input type="text" class="form-control" id="contentKey" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="contentDescription" class="form-label">Description</label>
                        <input type="text" class="form-control" id="contentDescription" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="contentValue" class="form-label">Content</label>
                        <textarea class="form-control" id="contentValue" rows="4" placeholder="Enter your content here..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveContent">
                    <i class="fas fa-save me-2"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.website-preview {
    position: relative;
    background: #f8f9fa;
    border-radius: 8px;
    overflow: hidden;
}

.editable-overlay {
    position: absolute;
    background: rgba(0, 123, 255, 0.1);
    border: 2px dashed #007bff;
    cursor: pointer;
    z-index: 1000;
    transition: all 0.2s ease;
}

.editable-overlay:hover {
    background: rgba(0, 123, 255, 0.2);
    border-color: #0056b3;
}

.editable-overlay::after {
    content: "Click to edit";
    position: absolute;
    top: -25px;
    left: 0;
    background: #007bff;
    color: white;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 12px;
    white-space: nowrap;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.editable-overlay:hover::after {
    opacity: 1;
}

.edit-highlight {
    background: rgba(40, 167, 69, 0.2) !important;
    border-color: #28a745 !important;
}

#previewFrame {
    transition: all 0.3s ease;
}

.edit-mode-active #previewFrame {
    pointer-events: none;
}

/* Real Website Content Styling */
.real-website-content {
    font-family: 'Poppins', sans-serif;
    line-height: 1.6;
    color: #333;
}

.real-website-content .hero-section {
    background: linear-gradient(135deg, #007ACC 0%, #0056b3 100%);
    color: white;
    padding: 4rem 0;
}

.real-website-content .display-4 {
    font-size: 2.5rem;
    font-weight: 700;
}

.real-website-content .lead {
    font-size: 1.25rem;
    font-weight: 300;
}

.real-website-content .btn {
    border-radius: 25px;
    padding: 12px 30px;
    font-weight: 500;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s ease;
}

.real-website-content .btn-light {
    background-color: white;
    color: #007ACC;
    border: none;
}

.real-website-content .btn-light:hover {
    background-color: #f8f9fa;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.real-website-content .btn-primary {
    background: linear-gradient(135deg, #007ACC 0%, #0056b3 100%);
    border: none;
    color: white;
}

.real-website-content .btn-primary:hover {
    background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.real-website-content .section-title {
    font-size: 2.25rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 1rem;
}

.real-website-content .feature-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 3px 15px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    border: none;
    height: 100%;
}

.real-website-content .feature-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.real-website-content .pricing-card {
    border-radius: 20px;
    border: 2px solid #e9ecef;
}

.real-website-content .pricing-amount {
    font-size: 3rem;
    font-weight: 700;
    color: #007ACC;
    line-height: 1;
}

.real-website-content .currency {
    font-size: 1.5rem;
    vertical-align: top;
}

.real-website-content .period {
    font-size: 1.2rem;
    color: #6c757d;
}

.real-website-content .countdown-timer {
    background: rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 1.5rem;
    margin: 1rem 0;
}

.real-website-content .img-fluid {
    max-width: 100%;
    height: auto;
    border-radius: 12px;
}

.real-website-content .bg-light {
    background-color: #f8f9fa !important;
}

.real-website-content .text-primary {
    color: #007ACC !important;
}

.real-website-content .text-success {
    color: #28a745 !important;
}

.real-website-content .text-info {
    color: #17a2b8 !important;
}

.real-website-content .text-muted {
    color: #6c757d !important;
}

/* Edit overlay hover effects */
.real-website-content [data-content-key] {
    transition: all 0.2s ease;
}

.real-website-content [data-content-key]:hover {
    outline: 2px dashed #007ACC;
    background-color: rgba(0, 122, 204, 0.05);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const editModeToggle = document.getElementById('editModeToggle');
    const editToolbar = document.getElementById('editToolbar');
    const saveAllChanges = document.getElementById('saveAllChanges');
    const cancelEditing = document.getElementById('cancelEditing');
    const undoEdit = document.getElementById('undoEdit');
    const redoEdit = document.getElementById('redoEdit');
    const changeCount = document.getElementById('changeCount');
    const pendingChanges = document.getElementById('pendingChanges');
    const pendingCount = document.getElementById('pendingCount');
    const saveStatus = document.getElementById('saveStatus');
    const realWebsiteContent = document.getElementById('realWebsiteContent');
    const editModal = new bootstrap.Modal(document.getElementById('editModal'));
    
    // Enhanced state management
    let editMode = false;
    let changes = {};
    let changeHistory = [];
    let currentHistoryIndex = -1;
    let autoSaveTimer = null;
    let lastSaveTime = Date.now();
    
    // Initialize real-time sync connection
    if (window.realtimeSync || window.simpleRealtime) {
        console.log('Real-time sync available for visual editor');
    }
    
    // Enhanced event listeners
    editModeToggle.addEventListener('click', () => toggleEditMode(!editMode));
    cancelEditing.addEventListener('click', () => toggleEditMode(false));
    saveAllChanges.addEventListener('click', saveAllPendingChanges);
    undoEdit.addEventListener('click', undoLastChange);
    redoEdit.addEventListener('click', redoLastChange);
    
    function toggleEditMode(enabled) {
        editMode = enabled;
        
        if (enabled) {
            editModeToggle.innerHTML = '<i class="fas fa-times me-2"></i>Exit Edit Mode';
            editModeToggle.classList.remove('btn-primary');
            editModeToggle.classList.add('btn-danger');
            editToolbar.style.display = 'block';
            addEditOverlays();
            updateEditStatus('Edit mode enabled - click elements to edit');
        } else {
            editModeToggle.innerHTML = '<i class="fas fa-edit me-2"></i>Enable Edit Mode';
            editModeToggle.classList.remove('btn-danger');
            editModeToggle.classList.add('btn-primary');
            editToolbar.style.display = 'none';
            removeEditOverlays();
            updateEditStatus('Edit mode disabled');
        }
        
        updateUI();
    }
    
    function addEditOverlays() {
        const editableElements = realWebsiteContent.querySelectorAll('[data-content-key]');
        
        editableElements.forEach(element => {
            element.classList.add('editable-element');
            element.style.cursor = 'pointer';
            element.style.transition = 'all 0.2s ease';
            
            // Add click handler for editing
            element.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                openEditModal(element);
            });
            
            // Add hover effect
            element.addEventListener('mouseenter', function() {
                this.style.outline = '2px dashed #007ACC';
                this.style.backgroundColor = 'rgba(0, 122, 204, 0.05)';
            });
            
            element.addEventListener('mouseleave', function() {
                this.style.outline = '';
                this.style.backgroundColor = '';
            });
        });
    }
    
    function removeEditOverlays() {
        const editableElements = realWebsiteContent.querySelectorAll('.editable-element');
        
        editableElements.forEach(element => {
            element.classList.remove('editable-element');
            element.style.cursor = '';
            element.style.outline = '';
            element.style.backgroundColor = '';
            
            // Remove event listeners by cloning element
            const newElement = element.cloneNode(true);
            element.parentNode.replaceChild(newElement, element);
        });
    }
    
    function openEditModal(element) {
        const contentKey = element.getAttribute('data-content-key');
        const contentType = element.getAttribute('data-content-type') || 'text';
        const currentValue = getElementValue(element, contentType);
        
        // Populate modal
        document.getElementById('editContentKey').value = contentKey;
        document.getElementById('editContentType').value = contentType;
        
        if (contentType === 'text') {
            document.getElementById('editTextValue').value = currentValue;
            document.getElementById('textEditor').style.display = 'block';
            document.getElementById('imageEditor').style.display = 'none';
        } else if (contentType === 'image') {
            document.getElementById('editImageValue').value = currentValue;
            document.getElementById('imageEditor').style.display = 'block';
            document.getElementById('textEditor').style.display = 'none';
        }
        
        // Show modal
        editModal.show();
    }
    
    function getElementValue(element, contentType) {
        if (contentType === 'image') {
            return element.src || element.getAttribute('src') || '';
        } else {
            return element.textContent || element.innerHTML || '';
        }
    }
    
    function setElementValue(element, value, contentType) {
        if (contentType === 'image') {
            element.src = value;
            element.setAttribute('src', value);
        } else {
            element.textContent = value;
        }
    }
    
    function recordChange(key, oldValue, newValue, contentType) {
        // Record change for undo/redo
        const change = {
            key: key,
            oldValue: oldValue,
            newValue: newValue,
            contentType: contentType,
            timestamp: Date.now()
        };
        
        // Remove any redo history when new change is made
        changeHistory = changeHistory.slice(0, currentHistoryIndex + 1);
        changeHistory.push(change);
        currentHistoryIndex = changeHistory.length - 1;
        
        // Add to pending changes
        changes[key] = {
            value: newValue,
            contentType: contentType,
            timestamp: Date.now()
        };
        
        updateUI();
        scheduleAutoSave();
    }
    
    function undoLastChange() {
        if (currentHistoryIndex >= 0) {
            const change = changeHistory[currentHistoryIndex];
            applyChange(change.key, change.oldValue, change.contentType);
            currentHistoryIndex--;
            
            // Remove from pending changes or update with old value
            if (currentHistoryIndex < 0) {
                delete changes[change.key];
            } else {
                const prevChange = changeHistory[currentHistoryIndex];
                if (prevChange.key === change.key) {
                    changes[change.key] = {
                        value: prevChange.newValue,
                        contentType: prevChange.contentType,
                        timestamp: Date.now()
                    };
                }
            }
            
            updateUI();
        }
    }
    
    function redoLastChange() {
        if (currentHistoryIndex < changeHistory.length - 1) {
            currentHistoryIndex++;
            const change = changeHistory[currentHistoryIndex];
            applyChange(change.key, change.newValue, change.contentType);
            
            // Add back to pending changes
            changes[change.key] = {
                value: change.newValue,
                contentType: change.contentType,
                timestamp: Date.now()
            };
            
            updateUI();
        }
    }
    
    function applyChange(key, value, contentType) {
        const elements = realWebsiteContent.querySelectorAll(`[data-content-key="${key}"]`);
        elements.forEach(element => {
            setElementValue(element, value, contentType);
        });
    }
    
    function updateUI() {
        const changeCountValue = Object.keys(changes).length;
        changeCount.textContent = changeCountValue;
        pendingCount.textContent = changeCountValue;
        
        // Update buttons
        saveAllChanges.style.display = changeCountValue > 0 ? 'inline-block' : 'none';
        pendingChanges.style.display = changeCountValue > 0 ? 'inline-block' : 'none';
        saveStatus.style.display = changeCountValue === 0 ? 'inline-block' : 'none';
        
        undoEdit.disabled = currentHistoryIndex < 0;
        redoEdit.disabled = currentHistoryIndex >= changeHistory.length - 1;
    }
    
    function updateEditStatus(message) {
        const statusBadge = document.querySelector('#editStatus .badge.bg-info');
        if (statusBadge) {
            statusBadge.innerHTML = `<i class="fas fa-info-circle me-1"></i>${message}`;
        }
    }
    
    function scheduleAutoSave() {
        if (autoSaveTimer) {
            clearTimeout(autoSaveTimer);
        }
        
        // Auto-save after 3 seconds of inactivity
        autoSaveTimer = setTimeout(() => {
            if (Object.keys(changes).length > 0) {
                saveAllPendingChanges();
            }
        }, 3000);
    }
    
    function saveAllPendingChanges() {
        if (Object.keys(changes).length === 0) {
            return;
        }
        
        updateEditStatus('Saving changes...');
        
        const updates = Object.keys(changes).map(key => ({
            key: key,
            value: changes[key].value,
            category: 'content',
            contentType: changes[key].contentType
        }));
        
        fetch('/admin/api/content/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ updates: updates })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                changes = {};
                lastSaveTime = Date.now();
                updateUI();
                updateEditStatus('All changes saved successfully');
                
                // Broadcast changes if real-time sync is available
                if (window.simpleRealtime && window.simpleRealtime.broadcastContentUpdate) {
                    window.simpleRealtime.broadcastContentUpdate(updates);
                }
                
                // Hide save status after 3 seconds
                setTimeout(() => {
                    if (Object.keys(changes).length === 0) {
                        updateEditStatus('Ready to edit');
                    }
                }, 3000);
            } else {
                updateEditStatus('Error saving changes');
                console.error('Save failed:', data.error);
            }
        })
        .catch(error => {
            updateEditStatus('Error saving changes');
            console.error('Save error:', error);
        });
    }
    
    // Modal save handler
    document.getElementById('saveEdit').addEventListener('click', function() {
        const contentKey = document.getElementById('editContentKey').value;
        const contentType = document.getElementById('editContentType').value;
        let newValue;
        
        if (contentType === 'text') {
            newValue = document.getElementById('editTextValue').value;
        } else if (contentType === 'image') {
            newValue = document.getElementById('editImageValue').value;
        }
        
        // Get current value for undo
        const elements = realWebsiteContent.querySelectorAll(`[data-content-key="${contentKey}"]`);
        const oldValue = elements.length > 0 ? getElementValue(elements[0], contentType) : '';
        
        // Apply change immediately
        applyChange(contentKey, newValue, contentType);
        
        // Record for undo/redo and saving
        recordChange(contentKey, oldValue, newValue, contentType);
        
        // Close modal
        editModal.hide();
        
        updateEditStatus(`Updated ${contentKey}`);
    });
    
    // Initialize UI
    updateUI();
                element.style.position = 'relative';
                element.style.cursor = 'pointer';
                element.style.border = '2px dashed transparent';
                element.style.transition = 'all 0.2s ease';
                
                // Add hover effects
                element.addEventListener('mouseenter', function() {
                    this.style.border = '2px dashed #007ACC';
                    this.style.backgroundColor = 'rgba(0, 122, 204, 0.1)';
                });
                
                element.addEventListener('mouseleave', function() {
                    this.style.border = '2px dashed transparent';
                    this.style.backgroundColor = 'transparent';
                });
                
                // Add click to edit
                element.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    openEditModal(this);
                });
                
                // Add edit icon overlay
                const editIcon = document.createElement('div');
                editIcon.className = 'edit-icon-overlay';
                editIcon.innerHTML = '<i class="fas fa-edit"></i>';
                editIcon.style.cssText = `
                    position: absolute;
                    top: 5px;
                    right: 5px;
                    background: #007ACC;
                    color: white;
                    border-radius: 50%;
                    width: 30px;
                    height: 30px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 12px;
                    opacity: 0;
                    transition: opacity 0.2s ease;
                    z-index: 1000;
                    pointer-events: none;
                `;
                
                element.appendChild(editIcon);
                
                // Show edit icon on hover
                element.addEventListener('mouseenter', function() {
                    editIcon.style.opacity = '1';
                });
                
                element.addEventListener('mouseleave', function() {
                    editIcon.style.opacity = '0';
                });
            }
        });
    }
    
    function removeEditOverlays() {
        const editableElements = realWebsiteContent.querySelectorAll('.edit-overlay-added');
        
        editableElements.forEach(element => {
            element.classList.remove('edit-overlay-added');
            element.style.border = '';
            element.style.backgroundColor = '';
            element.style.cursor = '';
            element.style.position = '';
            
            // Remove edit icons
            const editIcon = element.querySelector('.edit-icon-overlay');
            if (editIcon) {
                editIcon.remove();
            }
            
            // Remove event listeners (clone and replace to remove all listeners)
            const newElement = element.cloneNode(true);
            element.parentNode.replaceChild(newElement, element);
        });
    }
    
    function openEditModal(element) {
        const contentKey = element.getAttribute('data-content-key');
        const contentType = element.getAttribute('data-content-type') || 'text';
        
        // Populate modal
        document.getElementById('contentKey').value = contentKey;
        document.getElementById('contentDescription').value = getContentDescription(contentKey);
        
        // Get current content based on type
        let currentContent = '';
        if (contentType === 'image') {
            currentContent = element.src || element.getAttribute('src') || '';
        } else {
            currentContent = element.textContent || element.innerHTML || '';
        }
        
        document.getElementById('contentValue').value = currentContent;
        
        // Store current element reference
        editModal._currentElement = element;
        editModal._contentKey = contentKey;
        editModal._contentType = contentType;
        
        editModal.show();
    }
    
    function getContentDescription(key) {
        const descriptions = {
            'hero_title': 'Main homepage title',
            'hero_subtitle': 'Homepage subtitle text',
            'countdown_title': 'Countdown timer title',
            'program_title': 'Program section title',
            'program_subtitle': 'Program section subtitle',
            'feature1_title': 'First feature title',
            'feature1_description': 'First feature description',
            'feature2_title': 'Second feature title',
            'feature2_description': 'Second feature description',
            'feature3_title': 'Third feature title',
            'feature3_description': 'Third feature description',
            'pricing_title': 'Pricing section title',
            'pricing_plan_name': 'Pricing plan name',
            'early_bird_price': 'Early bird price',
            'regular_price': 'Regular price',
            'hero_image': 'Hero section image'
        };
        
        return descriptions[key] || `Edit ${key.replace(/_/g, ' ')}`;
    }
    
    // Save Content
    document.getElementById('saveContent').addEventListener('click', function() {
        const contentKey = document.getElementById('contentKey').value;
        const contentValue = document.getElementById('contentValue').value;
        const element = editModal._currentElement;
        const contentType = editModal._contentType;
        
        // Update the element immediately
        if (contentType === 'image') {
            element.src = contentValue;
        } else {
            element.textContent = contentValue;
        }
        
        // Store change for batch saving
        pendingChanges[contentKey] = {
            key: contentKey,
            value: contentValue,
            type: contentType
        };
        
        // Save immediately to backend
        saveContentToBackend(contentKey, contentValue);
        
        editModal.hide();
        
        // Show success feedback
        showNotification('Content updated successfully!', 'success');
    });
    
    function saveContentToBackend(key, value) {
        fetch('/admin/portal/update_content', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                updates: [{
                    key: key,
                    value: value
                }]
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Content saved to backend:', key);
                
                // Broadcast update via real-time sync
                if (window.realtimeSync && window.realtimeSync.broadcastContentUpdate) {
                    window.realtimeSync.broadcastContentUpdate([{
                        key: key,
                        value: value
                    }]);
                }
            } else {
                console.error('Failed to save content:', data.error);
                showNotification('Failed to save content: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error saving content:', error);
            showNotification('Error saving content', 'error');
        });
    }
    
    function showNotification(message, type = 'info') {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} notification-toast`;
        notification.textContent = message;
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        `;
        
        document.body.appendChild(notification);
        
        // Animate in
        setTimeout(() => {
            notification.style.opacity = '1';
            notification.style.transform = 'translateX(0)';
        }, 100);
        
        // Remove after delay
        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 300);
        }, 3000);
    }
    
    // Save All Changes
    if (saveAllChanges) {
        saveAllChanges.addEventListener('click', function() {
            if (Object.keys(pendingChanges).length === 0) {
                showNotification('No changes to save', 'info');
                return;
            }
            
            const updates = Object.values(pendingChanges);
            
            fetch('/admin/portal/update_content', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({ updates: updates })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    pendingChanges = {};
                    showNotification('All changes saved successfully!', 'success');
                    
                    // Broadcast updates via real-time sync
                    if (window.realtimeSync && window.realtimeSync.broadcastContentUpdate) {
                        window.realtimeSync.broadcastContentUpdate(updates);
                    }
                } else {
                    showNotification('Failed to save changes: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error saving changes:', error);
                showNotification('Error saving changes', 'error');
            });
        });
    }
            type: 'textarea'
        },
        'why_choose_title': {
            selector: 'h2:contains("Why Choose")',
            key: 'home_why_choose_title',
            description: 'Why Choose Section Title',
            type: 'text'
        },
        'why_choose_description': {
            selector: '.about-content p:first-of-type',
            key: 'home_why_choose_description',
            description: 'Why Choose Description',
            type: 'textarea'
        },
        'feature_1': {
            selector: '.feature-item:nth-child(1) span',
            key: 'home_feature_1_title',
            description: 'Feature 1 Title',
            type: 'text'
        },
        'feature_2': {
            selector: '.feature-item:nth-child(2) span',
            key: 'home_feature_2_title',
            description: 'Feature 2 Title',
            type: 'text'
        },
        'feature_3': {
            selector: '.feature-item:nth-child(3) span',
            key: 'home_feature_3_title',
            description: 'Feature 3 Title',
            type: 'text'
        },
        'program_highlights_title': {
            selector: '.program-highlights h2.section-title',
            key: 'home_program_highlights_title',
            description: 'Program Highlights Title',
            type: 'text'
        },
        'highlight_1_title': {
            selector: '.highlight-card:nth-child(1) h3',
            key: 'home_highlight_1_title',
            description: 'Program Highlight 1 Title',
            type: 'text'
        },
        'highlight_1_desc': {
            selector: '.highlight-card:nth-child(1) p',
            key: 'home_highlight_1_desc',
            description: 'Program Highlight 1 Description',
            type: 'textarea'
        },
        'highlight_2_title': {
            selector: '.highlight-card:nth-child(2) h3',
            key: 'home_highlight_2_title',
            description: 'Program Highlight 2 Title',
            type: 'text'
        },
        'highlight_2_desc': {
            selector: '.highlight-card:nth-child(2) p',
            key: 'home_highlight_2_desc',
            description: 'Program Highlight 2 Description',
            type: 'textarea'
        },
        'highlight_3_title': {
            selector: '.highlight-card:nth-child(3) h3',
            key: 'home_highlight_3_title',
            description: 'Program Highlight 3 Title',
            type: 'text'
        },
        'highlight_3_desc': {
            selector: '.highlight-card:nth-child(3) p',
            key: 'home_highlight_3_desc',
            description: 'Program Highlight 3 Description',
            type: 'textarea'
        },
        'highlight_4_title': {
            selector: '.highlight-card:nth-child(4) h3',
            key: 'home_highlight_4_title',
            description: 'Program Highlight 4 Title',
            type: 'text'
        },
        'highlight_4_desc': {
            selector: '.highlight-card:nth-child(4) p',
            key: 'home_highlight_4_desc',
            description: 'Program Highlight 4 Description',
            type: 'textarea'
        },
        'info_session_title': {
            selector: '.info-session-card h2.section-title',
            key: 'home_info_session_title',
            description: 'Info Session Title',
            type: 'text'
        },
        'info_session_desc': {
            selector: '.info-session-card .lead',
            key: 'home_info_session_desc',
            description: 'Info Session Description',
            type: 'textarea'
        }
    };
    
    editModeToggle.addEventListener('click', function() {
        editMode = !editMode;
        toggleEditMode();
    });
    
    cancelEditing.addEventListener('click', function() {
        editMode = false;
        toggleEditMode();
        changes = {};
    });
    
    function toggleEditMode() {
        if (editMode) {
            editModeToggle.innerHTML = '<i class="fas fa-eye me-2"></i>Preview Mode';
            editModeToggle.className = 'btn btn-secondary me-2';
            editToolbar.style.display = 'block';
            enableEditMode();
        } else {
            editModeToggle.innerHTML = '<i class="fas fa-edit me-2"></i>Enable Edit Mode';
            editModeToggle.className = 'btn btn-primary me-2';
            editToolbar.style.display = 'none';
            disableEditMode();
        }
    }
    
    function enableEditMode() {
        previewFrame.onload = function() {
            const frameDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
            
            // Add jQuery-like contains functionality for cross-frame compatibility
            function findElementsContaining(text, tagName = '*') {
                const elements = frameDoc.querySelectorAll(tagName);
                return Array.from(elements).filter(el => 
                    el.textContent.includes(text) && 
                    el.children.length === 0 // Only leaf nodes
                );
            }
            
            // Add click handlers to editable elements
            Object.keys(editableContent).forEach(contentId => {
                const config = editableContent[contentId];
                let elements = [];
                
                // Handle special selectors
                if (config.selector.includes(':contains(')) {
                    const match = config.selector.match(/(.+):contains\("([^"]+)"\)/);
                    if (match) {
                        const tagName = match[1];
                        const text = match[2];
                        elements = findElementsContaining(text, tagName);
                    }
                } else {
                    // Use regular querySelector
                    elements = Array.from(frameDoc.querySelectorAll(config.selector));
                }
                
                elements.forEach((element, index) => {
                    if (!element) return;
                    
                    // Create edit overlay
                    const overlay = frameDoc.createElement('div');
                    overlay.className = 'edit-overlay';
                    overlay.style.cssText = `
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        border: 2px dashed transparent;
                        background: transparent;
                        cursor: pointer;
                        z-index: 9999;
                        transition: all 0.2s ease;
                        pointer-events: auto;
                    `;
                    
                    // Position overlay relative to element
                    element.style.position = element.style.position || 'relative';
                    element.appendChild(overlay);
                    
                    // Add hover effects
                    overlay.addEventListener('mouseover', function() {
                        this.style.border = '2px dashed #007bff';
                        this.style.background = 'rgba(0, 123, 255, 0.15)';
                        
                        // Add tooltip
                        const tooltip = frameDoc.createElement('div');
                        tooltip.className = 'edit-tooltip';
                        tooltip.textContent = `Click to edit: ${config.description}`;
                        tooltip.style.cssText = `
                            position: absolute;
                            top: -30px;
                            left: 0;
                            background: #007bff;
                            color: white;
                            padding: 4px 8px;
                            border-radius: 4px;
                            font-size: 12px;
                            white-space: nowrap;
                            z-index: 10000;
                            pointer-events: none;
                        `;
                        this.appendChild(tooltip);
                    });
                    
                    overlay.addEventListener('mouseout', function() {
                        this.style.border = '2px dashed transparent';
                        this.style.background = 'transparent';
                        
                        // Remove tooltip
                        const tooltip = this.querySelector('.edit-tooltip');
                        if (tooltip) tooltip.remove();
                    });
                    
                    overlay.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        openEditModal(config, element.textContent.trim());
                    });
                });
            });
        };
        
        // Reload frame to apply edit handlers
        previewFrame.src = previewFrame.src;
    }
    
    function disableEditMode() {
        previewFrame.onload = null;
        previewFrame.src = previewFrame.src;
    }
    
    function openEditModal(config, currentValue) {
        document.getElementById('contentKey').value = config.key;
        document.getElementById('contentDescription').value = config.description;
        document.getElementById('contentValue').value = currentValue;
        editModal.show();
    }
    
    document.getElementById('saveContent').addEventListener('click', function() {
        const key = document.getElementById('contentKey').value;
        const value = document.getElementById('contentValue').value;
        
        changes[key] = value;
        
        // Show save button if there are changes
        if (Object.keys(changes).length > 0) {
            saveAllChanges.style.display = 'inline-block';
        }
        
        editModal.hide();
        
        // Update the preview
        updatePreview(key, value);
    });
    
    function updatePreview(key, value) {
        const frameDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
        
        // Find and update the corresponding element
        Object.keys(editableContent).forEach(contentId => {
            const config = editableContent[contentId];
            if (config.key === key) {
                const elements = frameDoc.querySelectorAll(config.selector);
                elements.forEach(element => {
                    element.textContent = value;
                    element.style.background = 'rgba(40, 167, 69, 0.2)';
                    setTimeout(() => {
                        element.style.background = 'transparent';
                    }, 1000);
                });
            }
        });
    }
    
    saveAllChanges.addEventListener('click', function() {
        // Send all changes to server
        fetch('/admin/visual-editor/save', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(changes)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Changes saved successfully!');
                changes = {};
                saveAllChanges.style.display = 'none';
                
                // Reload the main website
                previewFrame.src = previewFrame.src;
            } else {
                alert('Error saving changes: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error saving changes');
        });
    });
});
</script>
{% endblock %}