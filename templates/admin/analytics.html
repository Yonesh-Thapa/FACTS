{% extends "admin/layout.html" %}

{% block title %}F.A.C.T.S - Site Analytics{% endblock %}

{% block page_title %}Site Analytics{% endblock %}

{% block head_extras %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css">
<style>
    .analytics-card {
        margin-bottom: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    
    .chart-container {
        position: relative;
        margin: auto;
        height: 300px;
        width: 100%;
    }
    
    .metric-card {
        background-color: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        text-align: center;
        transition: transform 0.3s ease;
    }
    
    .metric-card:hover {
        transform: translateY(-5px);
    }
    
    .metric-card .metric-icon {
        font-size: 2.5rem;
        margin-bottom: 15px;
        color: var(--primary-color);
    }
    
    .metric-card .metric-value {
        font-size: 2rem;
        font-weight: 700;
        color: #333;
        margin-bottom: 5px;
    }
    
    .metric-card .metric-label {
        color: #777;
        font-size: 0.9rem;
    }
    
    .table-container {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .filter-controls {
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }
    
    @media (max-width: 768px) {
        .metric-card .metric-icon {
            font-size: 2rem;
        }
        
        .metric-card .metric-value {
            font-size: 1.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Time Range Filter -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="filter-controls">
                        <div class="btn-group" role="group" aria-label="Time range">
                            <a href="{{ url_for('admin_analytics', time='today') }}" class="btn btn-outline-primary {{ 'active' if time_filter == 'today' else '' }}">Today</a>
                            <a href="{{ url_for('admin_analytics', time='week') }}" class="btn btn-outline-primary {{ 'active' if time_filter == 'week' else '' }}">Last 7 Days</a>
                            <a href="{{ url_for('admin_analytics', time='month') }}" class="btn btn-outline-primary {{ 'active' if time_filter == 'month' else '' }}">Last 30 Days</a>
                            <a href="{{ url_for('admin_analytics', time='all') }}" class="btn btn-outline-primary {{ 'active' if time_filter == 'all' or not time_filter else '' }}">All Time</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Key Metrics Row -->
    <div class="row mb-4">
        <div class="col-md-3 col-sm-6 mb-3 mb-md-0">
            <div class="metric-card">
                <div class="metric-icon"><i class="fas fa-users" aria-hidden="true"></i></div>
                <div class="metric-value">{{ total_visitors }}</div>
                <div class="metric-label">Total Visitors</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3 mb-md-0">
            <div class="metric-card">
                <div class="metric-icon"><i class="fas fa-file" aria-hidden="true"></i></div>
                <div class="metric-value">{{ total_page_views }}</div>
                <div class="metric-label">Page Views</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3 mb-md-0">
            <div class="metric-card">
                <div class="metric-icon"><i class="fas fa-clock" aria-hidden="true"></i></div>
                <div class="metric-value">{{ avg_duration_minutes }}m</div>
                <div class="metric-label">Avg. Session Duration</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6">
            <div class="metric-card">
                <div class="metric-icon"><i class="fas fa-percentage" aria-hidden="true"></i></div>
                <div class="metric-value">{{ bounce_rate }}%</div>
                <div class="metric-label">Bounce Rate</div>
            </div>
        </div>
    </div>
    
    <!-- Visitors Chart -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card analytics-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Visitor Traffic</h5>
                    <div class="btn-group btn-group-sm" role="group" aria-label="Chart view options">
                        <button type="button" class="btn btn-outline-secondary active">Daily</button>
                        <button type="button" class="btn btn-outline-secondary">Weekly</button>
                        <button type="button" class="btn btn-outline-secondary">Monthly</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="visitorsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Popular Pages & Geographic Data -->
    <div class="row mb-4">
        <div class="col-md-6 mb-4 mb-md-0">
            <div class="card analytics-card h-100">
                <div class="card-header">
                    <h5 class="mb-0">Most Visited Pages</h5>
                </div>
                <div class="card-body">
                    <div class="table-container">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Page</th>
                                    <th>Views</th>
                                    <th>Avg. Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for page in popular_pages %}
                                <tr>
                                    <td>{{ page.page }}</td>
                                    <td>{{ page.views }}</td>
                                    <td>{{ page.avg_time }}</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="3" class="text-center">No page view data available yet</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card analytics-card h-100">
                <div class="card-header">
                    <h5 class="mb-0">Visitor Locations</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="locationChart"></canvas>
                    </div>
                    <div class="table-container mt-3">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Country</th>
                                    <th>Visitors</th>
                                    <th>% of Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for location in locations %}
                                <tr>
                                    <td>{{ location.country }}</td>
                                    <td>{{ location.visitors }}</td>
                                    <td>{{ location.percentage }}%</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="3" class="text-center">No location data available yet</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Referrals & Conversion -->
    <div class="row mb-4">
        <div class="col-md-6 mb-4 mb-md-0">
            <div class="card analytics-card h-100">
                <div class="card-header">
                    <h5 class="mb-0">Traffic Sources</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="referralChart"></canvas>
                    </div>
                    <div class="table-container mt-3">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Source</th>
                                    <th>Visitors</th>
                                    <th>Conversion Rate</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for referral in referrals %}
                                <tr>
                                    <td>{{ referral.source }} ({{ referral.medium }})</td>
                                    <td>{{ referral.visitors }}</td>
                                    <td>{{ referral.conversion_rate }}%</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="3" class="text-center">No referral data available yet</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card analytics-card h-100">
                <div class="card-header">
                    <h5 class="mb-0">Button Click Tracking</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="buttonClickChart"></canvas>
                    </div>
                    <div class="table-container mt-3">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Button</th>
                                    <th>Clicks</th>
                                    <th>Conversion Rate</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for button in button_clicks %}
                                <tr>
                                    <td>{{ button.button }}</td>
                                    <td>{{ button.clicks }}</td>
                                    <td>{{ button.conversion_rate }}%</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="3" class="text-center">No button click data available yet</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Real-time Analytics Notice -->
    <div class="row">
        <div class="col-12">
            <div class="alert alert-success">
                <h5><i class="fas fa-check-circle" aria-hidden="true"></i> Real-time Analytics Active</h5>
                <p class="mb-0">This dashboard is displaying real-time analytics data tracked directly from user interactions with the website. The data shown here reflects actual user behavior and is automatically updated as visitors interact with the site.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set Chart.js defaults
    Chart.defaults.font.family = "'Poppins', 'Helvetica', 'Arial', sans-serif";
    Chart.defaults.font.size = 13;
    Chart.defaults.color = '#6c757d';
    Chart.defaults.plugins.legend.position = 'bottom';
    
    // Visitors Chart with real data
    const visitorsCtx = document.getElementById('visitorsChart').getContext('2d');
    const visitorsChart = new Chart(visitorsCtx, {
        type: 'line',
        data: {
            labels: {{ chart_labels|tojson }},
            datasets: [{
                label: 'Visitors',
                data: {{ chart_visitors|tojson }},
                backgroundColor: 'rgba(0, 122, 204, 0.1)',
                borderColor: '#007ACC',
                borderWidth: 2,
                tension: 0.3,
                fill: true
            }, {
                label: 'Page Views',
                data: {{ chart_pageviews|tojson }},
                backgroundColor: 'rgba(46, 204, 113, 0.1)',
                borderColor: '#2ECC71',
                borderWidth: 2,
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        drawBorder: false
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
    
    // Location Chart (Doughnut)
    const locationCtx = document.getElementById('locationChart').getContext('2d');
    const locationChart = new Chart(locationCtx, {
        type: 'doughnut',
        data: {
            labels: ['Australia', 'New Zealand', 'India', 'United States', 'United Kingdom', 'Others'],
            datasets: [{
                data: [73.4, 9.3, 5.9, 5.1, 3.4, 2.9],
                backgroundColor: [
                    '#007ACC',
                    '#2ECC71',
                    '#F39C12',
                    '#E74C3C',
                    '#9B59B6',
                    '#95A5A6'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });
    
    // Referral Chart (Pie)
    const referralCtx = document.getElementById('referralChart').getContext('2d');
    const referralChart = new Chart(referralCtx, {
        type: 'pie',
        data: {
            labels: ['Google Search', 'Direct Traffic', 'Instagram', 'Facebook', 'Email', 'LinkedIn'],
            datasets: [{
                data: [43.1, 23.2, 15.7, 8.0, 6.0, 4.0],
                backgroundColor: [
                    '#4285F4', // Google blue
                    '#007ACC', // Direct blue
                    '#E1306C', // Instagram pink
                    '#3b5998', // Facebook blue
                    '#2ECC71', // Email green
                    '#0077B5'  // LinkedIn blue
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });
    
    // Button Click Chart (Bar)
    const buttonClickCtx = document.getElementById('buttonClickChart').getContext('2d');
    const buttonClickChart = new Chart(buttonClickCtx, {
        type: 'bar',
        data: {
            labels: ['Apply Now', 'Join Session', 'Contact Us', 'Find Out More', 'Software Training', 'Submit'],
            datasets: [{
                label: 'Clicks',
                data: [765, 654, 542, 487, 432, 376],
                backgroundColor: '#007ACC',
                borderWidth: 0
            }, {
                label: 'Conversion Rate (%)',
                data: [8.3, 7.2, 9.4, 6.8, 5.7, 25.3],
                backgroundColor: '#2ECC71',
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.dataset.label.includes('Conversion')) {
                                label += context.raw + '%';
                            } else {
                                label += context.raw;
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        drawBorder: false
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
    
    // Time range filter buttons
    const timeRangeButtons = document.querySelectorAll('.btn-group[aria-label="Time range"] .btn');
    timeRangeButtons.forEach(button => {
        button.addEventListener('click', function() {
            timeRangeButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            // In real implementation, this would trigger data reload
        });
    });
    
    // Chart view options
    const chartViewButtons = document.querySelectorAll('.btn-group[aria-label="Chart view options"] .btn');
    chartViewButtons.forEach(button => {
        button.addEventListener('click', function() {
            chartViewButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            // In real implementation, this would change chart grouping
        });
    });
});
</script>
{% endblock %}