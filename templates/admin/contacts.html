{% extends "admin/layout.html" %}

{% block title %}F.A.C.T.S - Contact Submissions{% endblock %}

{% block page_title %}Contact Submissions{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <span>All Contact Form Submissions</span>
            </div>
            <div class="card-body">
                {% if contacts %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Subject</th>
                                <th>Message</th>
                                <th>Date</th>
                                <th>Interested</th>
                                <th>Status</th>
                                <th>Class</th>
                                <th>Enrolled</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for contact in contacts %}
                            <tr class="{% if not contact.is_read %}table-primary{% endif %}"
                                {% if not contact.is_read %}style="font-weight: bold;"{% endif %}>
                                <td>
                                    <a href="#" class="contact-name" data-bs-toggle="modal" data-bs-target="#messageModal{{ contact.id }}"
                                       {% if not contact.is_read %}data-contact-id="{{ contact.id }}"{% endif %}>
                                        {{ contact.name }}
                                    </a>
                                </td>
                                <td><a href="mailto:{{ contact.email }}">{{ contact.email }}</a></td>
                                <td>{{ contact.subject or "N/A" }}</td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-outline-primary view-message-btn" data-bs-toggle="modal" data-bs-target="#messageModal{{ contact.id }}"
                                        {% if not contact.is_read %}data-contact-id="{{ contact.id }}"{% endif %}>
                                        View Message
                                    </button>
                                    
                                    <!-- Modal for displaying the message -->
                                    <div class="modal fade" id="messageModal{{ contact.id }}" tabindex="-1" aria-labelledby="messageModalLabel{{ contact.id }}" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="messageModalLabel{{ contact.id }}">Message from {{ contact.name }}</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <p><strong>Subject:</strong> {{ contact.subject or "N/A" }}</p>
                                                    <p><strong>Message:</strong></p>
                                                    <div class="p-3 bg-light rounded">
                                                        {{ contact.message|nl2br }}
                                                    </div>
                                                    <div class="mt-3">
                                                        <p><strong>Assign to Class:</strong></p>
                                                        <form method="POST" action="{{ url_for('assign_contact_to_class', contact_id=contact.id) }}" class="row g-3 align-items-end">
                                                            <div class="col-md-8">
                                                                <select name="class_assignment" class="form-select" aria-label="Assign to class">
                                                                    <option value="" {% if not contact.class_assignment %}selected{% endif %}>-- Unassigned --</option>
                                                                    <option value="fall" {% if contact.class_assignment == 'fall' %}selected{% endif %}>Fall Class</option>
                                                                    <option value="spring" {% if contact.class_assignment == 'spring' %}selected{% endif %}>Spring Class</option>
                                                                </select>
                                                            </div>
                                                            <div class="col-md-4">
                                                                <button type="submit" class="btn btn-primary">Save</button>
                                                            </div>
                                                        </form>
                                                    </div>
                                                    
                                                    {% if contact.class_assignment and not contact.is_enrolled %}
                                                    <div class="mt-4">
                                                        <p><strong>Enroll Student:</strong></p>
                                                        <form method="POST" action="{{ url_for('enroll_contact', contact_id=contact.id) }}" class="row g-3 align-items-end">
                                                            <div class="col-md-8">
                                                                <label for="phone" class="form-label">Phone Number (optional)</label>
                                                                <input type="tel" class="form-control" name="phone" id="phone" value="{{ contact.phone or '' }}" placeholder="e.g. 0449 XXX XXX">
                                                            </div>
                                                            <div class="col-md-4">
                                                                <button type="submit" class="btn btn-success">
                                                                    <i class="fas fa-user-graduate"></i> Enroll Student
                                                                </button>
                                                            </div>
                                                        </form>
                                                    </div>
                                                    {% elif contact.is_enrolled %}
                                                    <div class="mt-4">
                                                        <div class="alert alert-success">
                                                            <i class="fas fa-check-circle"></i> Student is enrolled in {{ contact.class_assignment|title }} class.
                                                            {% if contact.phone %}
                                                            <p class="mb-0"><strong>Phone:</strong> {{ contact.phone }}</p>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    {% endif %}
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                                    <form method="POST" action="{{ url_for('delete_contact', contact_id=contact.id) }}" class="d-inline delete-form">
                                                        <button type="submit" class="btn btn-danger" title="Delete" onclick="return confirm('Are you sure you want to delete this message?')">
                                                            <i class="fas fa-trash"></i> Delete
                                                        </button>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td>{{ contact.created_at.strftime('%d %b %Y, %H:%M') }}</td>
                                <td>
                                    {% if contact.interested %}
                                    <span class="badge bg-success">Yes</span>
                                    {% else %}
                                    <span class="badge bg-secondary">No</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if not contact.is_read %}
                                    <form method="POST" action="{{ url_for('mark_contact_as_read', contact_id=contact.id) }}" class="d-inline">
                                        <button type="submit" class="btn btn-sm btn-outline-success" title="Mark as Read">
                                            <i class="fas fa-check"></i> Mark Read
                                        </button>
                                    </form>
                                    {% else %}
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-light text-dark me-2">Read</span>
                                        <form method="POST" action="{{ url_for('mark_contact_as_unread', contact_id=contact.id) }}" class="d-inline">
                                            <button type="submit" class="btn btn-sm btn-outline-warning" title="Mark as Unread">
                                                <i class="fas fa-undo"></i>
                                            </button>
                                        </form>
                                    </div>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if contact.class_assignment %}
                                        <span class="badge bg-primary">{{ contact.class_assignment|title }}</span>
                                    {% else %}
                                        <span class="badge bg-light text-dark">Unassigned</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if contact.is_enrolled %}
                                        <span class="badge bg-success">Enrolled</span>
                                    {% elif contact.class_assignment %}
                                        <form method="POST" action="{{ url_for('enroll_contact', contact_id=contact.id) }}" class="d-inline">
                                            <button type="submit" class="btn btn-sm btn-outline-success" title="Enroll Student">
                                                <i class="fas fa-user-graduate"></i> Enroll
                                            </button>
                                        </form>
                                    {% else %}
                                        <span class="badge bg-light text-dark">Not Eligible</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <form method="POST" action="{{ url_for('delete_contact', contact_id=contact.id) }}" class="d-inline delete-form">
                                        <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete" onclick="return confirm('Are you sure you want to delete this message?')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-center py-3">No contact submissions yet.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block head_extras %}
<style>
    .modal-body {
        white-space: pre-line; /* Preserve line breaks */
    }
    
    .contact-name {
        font-weight: inherit;
        text-decoration: none;
        color: var(--primary-color);
        cursor: pointer;
    }
    
    .contact-name:hover {
        text-decoration: underline;
    }
    
    .table tr.table-primary .contact-name {
        font-weight: bold;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle marking messages as read when viewing
        const viewButtons = document.querySelectorAll('.view-message-btn[data-contact-id], .contact-name');
        viewButtons.forEach(button => {
            button.addEventListener('click', function() {
                const contactId = this.getAttribute('data-contact-id') || 
                                 this.closest('tr').querySelector('.view-message-btn').getAttribute('data-contact-id');
                
                if (contactId) {
                    // Send AJAX request to mark as read
                    fetch(`/admin/contacts/${contactId}/mark-read-ajax`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Update UI to show as read
                            const row = this.closest('tr');
                            row.classList.remove('table-primary');
                            row.style.fontWeight = 'normal';
                            
                            const statusCell = row.querySelector('td:nth-child(7)');
                            if (statusCell) {
                                statusCell.innerHTML = '<span class="badge bg-light text-dark">Read</span>';
                            }
                            
                            // Remove data attribute to prevent duplicate requests
                            this.removeAttribute('data-contact-id');
                            row.querySelector('.view-message-btn').removeAttribute('data-contact-id');
                            
                            // Update the badge in the sidebar if it exists
                            const badge = document.querySelector('.sidebar-menu .badge');
                            if (badge) {
                                const count = parseInt(badge.textContent) - 1;
                                if (count <= 0) {
                                    badge.remove();
                                } else {
                                    badge.textContent = count;
                                }
                            }
                        }
                    })
                    .catch(error => console.error('Error marking message as read:', error));
                }
            });
        });
    });
</script>
{% endblock %}